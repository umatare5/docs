# スタイルガイドとルール

- Google のスタイルガイドは、エンジニアが結果責任を負うルールの、最終的な典拠としての役目を果たす
- スタイルガイドは Google で利用される各プログラミング言語別に保守されている
- スタイルガイドに決定版は存在しない
- コードを持続可能とするルールは要件により異なる

## 何故ルールを設けるのか

- ルールを設置することのゴールは、「良い」行動を促し、「悪い」行動を思いとどまらせることである。
- 「良い」「悪い」の解釈は組織によって異なり、その組織が何に関心を持っているかに依存する。
- ルールの策定は、共通の開発パターンを望ましい方向へ推し進めるための促進剤となる。

## ルールを作る

- 大事なことは「どんなルールを備えるべきか」ではない。「どんなゴールを前進させようとしているのか」である。
- Google では「スタイルガイドに何が入るか」ではなく、「なぜそれがスタイルガイドに入るのか」を考える。

## 指導原則

- Google では

  - 3 万人以上のエンジニアから成る
  - スキルとバックグラウンドは凄まじい多様性を呈している
  - 何十年も存続する 20 億行以上のコードベースに、毎日約 6 万件のコミットが入る
  - スケールと時間の双方に対して、強靭なエンジニアリング環境を持続させる必要がある

- Google のゴール

  - 開発環境の複雑性を管理し、コードベースを管理可能なものに保ちつつも、エンジニアが相変わらず精算的に働けること
  - ゴールに向かうのを手伝うルールが大量にあることが意味するのは、我々が選択を制限しているということになる
  - ルールとして制定された標準によってもたらされる利益 (一貫性の工場と競合の減少) は、そのデメリットに勝る

- Google のルール導入基準
  - 他のルールと同程度に有用であれ
  - 読者にむけて最適化せよ
  - 一貫性を保て
  - 誤りが起きやすく意外な構文は避けよ
  - 必要なら現実問題に譲歩せよ

### 他のルールと同程度に有用であれ

- 何でもかんでもスタイルガイドに入れるべきではない
  - ルールが多すぎると、コードを書く再に関連するルールを全部思い出すのが難しい
  - 新しいエンジニアがコードの書き方を学習するのも難しい
  - ルールが多くなると、ルールのセットの保守も困難になりコストがあがる
- Google では、自明であることが予期されるルールはスタイルガイドに含めない
  - マイノリティな訂正のたびに全員に負荷をかけていては組織がスケールしない

### 読者にむけて最適化せよ

- Google では、コードの作者より読者にむけて最適化する、というルールがある
  - 時間の経過を前提とすると、コードは書かれるより読まれることのほうが圧倒的に多い
  - Google は「書くのが簡単である」点より「読むのが簡単」である点に価値を置く
- エンジニアが繰り返し、比較的長く説明的な名前の変数や型を入力するため先行コストは増える
  - Google がこのコストを選択しているのは、このルールが将来の全読者にむけて提供するリーダビリティのためである
  - 読者がコードを読む再は、そのコードが何をやっているのか明確に理解出来ることが望ましい
  - たとえば、上位クラスのメソッドを overridde する場合、必ず `override` アノテーションを付与する
  - 設計に関しコード内に書かれた明示的なエビデンスがなければ読者はその糸を探り当てる
  - しかし、コードを読み解いていくという探求の手間が読者の側に都度発生することになる
- ドキュメンテーションのコメントは、続くコードの設計また意図を説明する
- 実装コメントは、明白でない選択について、正しい選択であることを示すか、その選択に注意を向けさせる
- Google はこれら双方の類型コメントを扱うスタイルガイド用ルールを利用している

## 一貫性を保て

- コードベースの馴染みのない部分に突然入っていったとしても、一貫性が保たれていることが理想である
  - 局所的なプロジェクトは、それ自身の独特な個性を帯びている場合がある
  - だが、ツールは同じ、テクニックは同じ、ライブラリは同じ、そして全てが機能する
  - これにより、効率的に業務を開始することが出来る
- 一貫性の見解は、Google のオフィスが我々に適用している哲学に似ている
  - 大規模で分散したエンジニアリング母集団を擁すると、チームがオフィスごとに別れていることが多い
  - グーグラーは気がつくと他の拠点に出張していることも頻繁にある
  - 各オフィスは現地の風情と様式を受け入れて、それぞれの個性を維持している
  - 一方で、仕事をやりとげるのに必要なものは、どんなものであれ世界中で同じようになるよう意図的に保たれている
- 他拠点を訪れるグーグラーは、自分の社員証が現地にある入館用の社員証読み取り機の全てに対して有効であると、行く前から想像がつく
  - どの Google デバイスも常に WiFi にアクセス出来る
  - どの会議室のビデオ会議設定も同じインターフェイスをろ萎えているはずである
  - グーグラーはこうしたもの全ての操作方法を学ぶのに時間を費やす必要がない
  - どこにいようが、そうしたものは同じだろうということが、グーグラーには判っている
- 各オフィスにおいて社員証読み取り機やビデオ会議インターフェイスをカスタマイズすることが禁じられているのは、制限がきついと感じるかもしれない
  - だが、一貫性のもたらす利益が、我々の失う創造的自由をはるかに凌ぐ
- コードについても同様である
  - 一貫性があることはときに高速がきついように感じられるかもしれない
  - しかし、一貫性があれば、比較的少ない努力で比較的多くの仕事をやり遂げるエンジニアが増える

### 一貫性の優位性

- コードベースに、そのスタイルと規範において内部的な一貫性がある場合、コードを書いているエンジニアと、それを読んでいる他のエンジニアは、コードがどのように提示されているかというより、コード内で行われている内容に集中出来る。
  - この一貫性は、熟練者によるチャンク化をかなりの程度まで可能とする。
  - 問題を同じインターフェイスを通じて解き、コードを一貫性のある形で書式修正すると、何らかののコードを眺めてじゅうようなものに的を絞り、それが何をやっているかを理解するのが熟練者にとって容易になる
  - 一貫性は、コードのモジュール化と重複の発見も容易にする。
  - これらの理由で、一貫性のある命名規則、共通パターンの一貫性のある利用、一貫性のある書式整形と構造に、我々は相当な注意を払っている
- 一貫性はスケーリングを可能にする。
  - ツール環境は組織がスケールするための鍵であり、一貫性のあるコードは、コードを理解でき、編集でき、生成できるツールを開発しやすくしてくれる。
  - 異なる小さなコードを誰もが局所的に持っていたら、均一性に依存するツールの恩恵を全て受けることは出来ない。
  - あるいは、ツールがかけている import 文を追加したり、不要な include 文を削除してソースファイルを更新し続けられているとして、import 文のリストをソートするのに別々のプロジェクトが別々の戦略を選択していたら、そのツールはどこでも稼働できるというわけにはいかないかもしれない
  - 誰もが同じコンポーネントを使い、全員のコードが構造と構成について同じルールに従えば、場所を問わず稼働するツール環境に投資でき、保守タスクの多くに自動処理を組み込める。
  - 各チームが個別に、各々の独特な環境に向けて最適化された同様のツールの特性バージョンに投資しなければならないとしたら、そのような利点が失われることになる。
- 組織の人間的な部分をスケールさえる際にも一貫性は役に立つ。
  - 組織の発展に伴い、コードベース上で作業するエンジニアの人数は増加する。
  - 全員が作業しているコードを可能な限り一貫性のあるものとしておくことで、プロジェクト間での流動性を高めることが出来、チームを乗り越えるエンジニアの立ち上がり期間を最小化し、ヘッドカウント変動が必要な場合にあわせて伸縮し、適応する能力が組織に組み込まれていく。
  - 組織が発展しているということは、ソフトウェアエンジニア意外の役職の者がコードと触れ合うことを意味する。
  - たとえば、SRE / ライブラリエンジニア、コード管理者などがこれに該当する。
  - Google では、これらの役職が複数プロジェクト間にまたがることも多い。
  - あるチームのプロジェクトに詳しくないエンジニアが突然入ってきて、そのプロジェクトのコード上で作業するかもしれないというわけだ。
  - コードと触れ合う体験に、コードベースを横断する一貫性があれば、そのようなことが効率的になる
- 一貫性は、時間に対する強靭さを保証する
  - 時間が経過するにつれて、エンジニアがブロジェクトをリッだつし、新しい者が参加し、オーナーシップは移、プリオジェクトは合併や分裂をする。
  - 一貫性のあるコードベースを目指すことで、そのような移行コストが低いことが保証され、コードとそれに対して作業するエンジニアの双方についてほぼ成約のない流動性が与えられ、長期保守に必要なプロセスが簡略化される。
- Google が一貫性をすすめる場合、社内での一貫性を中心に置く傾向がある。
  - とくどき、全体的な規定が採択される前に局所的な規定が生じることがある
  - 全てが一致するように調整するのは合理的ではない
  - その場合、我々が勧めるのは、一貫性の改装である
  - 「一貫性を保て」というのは局所的に始まり、そこでは任意のファイル名での規範が任意のチームでの規範に優先し、任意のチームでの規範がより大きなプロジェクトの規範に優先し、より大きなプロジェクトの規範に優先し、より大きなプロジェクトの規範がコードベース全体の規範に優先する。
- 実際のスタイルガイドは、局所的な規定に判断を明示的に委ねる規定をかなり含み、科学的に基づく技術的判断より、こうした局所的な一貫性を重んじている
  - しかし組織にとっては社内規定のセットを作成して古酒していれば常に事足りるわけではない
  - ときには、社外のコミュニティが採択した標準も考慮に入れるべきである
- 規定が既に存在するのなら、組織を外部の世界と一貫性があるようにするのが一般的には良い考えである
  - 時間の経過と潜在的なスケーリングを絡めると、コードが外部のプロジェクトと接触したり、それどころか外部の世界に公開される結果になりさえする可能性が高まる
  - 長い目で見れば、広く受け入れられた標準を守っておいたほうが無難だろう

### 誤りが起きやすく意外な構文は避けよ

- 利用しているプログラミング言語の、どちらかといえば意外だったり奇妙だったり扱いにくかったりする一部の構文の利用は、Google では制限されている
  - 複雑な機能には、一見見たくらいでは明らかに出来ない微妙な落とし穴があることが多い
  - そのような複雑な機能を、その複雑性を理解し尽くさずに使うと、使い方を誤ってバグを招きやすい
  - ある構文がプロジェクトのエンジニアによく理解されているとしても、将来のプロジェクトメンバーと保守担当者が同じ理解を持つことが保証されるわけではない
- 高度な言語機能は、それらの機能を活用する方法を汁専門家にとっては問題を解決してくれるかもしれない
  - しかし、強力な機能は理解が比較的難しいことが多く、あまり広範に使われるわけではない
  - エンジニアは、全員がコードベース内で作業出来るようにならなければならない
  - 専門家だけが作業できれば良いわけではない
  - 全員が作業出来る状態は、新人ソフトウェアエンジニアによって助かるだけでなく、SRE にとっても扱いやすい
- SRE は本番の障害をデバッグしている場合、自分が通じているわけではない言語で書かれたコードだったとしても怪しければどんな点も調べることになる
  - 理解と保守が楽な、完結で明快なコードはこの大きな手助けとなる

### 現実問題に譲歩せよ

- スタイルガイドは例外を許容すべきである
- スタイルガイドの例外は必ず発生する
- パフォーマンスはスタイルガイドよりも優先される

## スタイルガイド

スタイルガイドは、以下 3 点を目的とする。

- 危険を避けるためのルール
- ベストプラクティスを矯正するためのルール
- 一貫性を保証するためのルール

## ルールを変更する

- Google のスタイルガイドは静的ではない
  - 大半のものがそうであるように、時間の経過を前提とすると、スタイルガイドの決定がなされた情勢と、任意の裁定を導いた要因は、おそらく変化する
  - たとえば、言語の新しいバージョンがリリースされると、機能やイディオムに変更が発生する

## ルールを適用する

人間の教育により適用する方法と、機械的に適用する方法が存在する。Google ではそれぞれ以下を通じて実現している。

- 教育により適用する方法
  - 各種の正式なトレーニングコース
  - 最新のドキュメントの提供
  - コードレビュー
- 機械的に適用する方法
  - エラーチェッカー
  - コードフォーマッター

## まとめ

- ルールとガイダンスは時間とスケーリングに対する強靭さをサポートすることを目指すべきである
- ルールを調整できるように、データ (コード、ドメイン etc) を知るべきである
- 全てがルールとなるべきではない
- 一貫性が鍵である
- ルールの矯正は、可能なら自動化せよ
